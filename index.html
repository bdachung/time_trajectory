<!DOCTYPE html>
<html>
<head>
    <title>File Upload</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

    <link rel="stylesheet" href="/static/style.css">

    <script src="/static/fileUpload.js"></script>

    <style>

        #content{
            display: flex;
        }

        #container{
            padding-top: 10px;
        }

        body{
            background-color: antiquewhite;
        }

    </style>

    <meta name="viewport" content="width=device-width, initial-scale=1">

</head>
<body>
    <div id="container">
        <h2 style="text-align: center;">Time trajectory inferene - supported by scDHA package</h2>

        <div>
            <h3>Welcome! To do time inference, please upload the following files</h3>
            <ul>
                <li>
                    <span>a single-cell RNA-seq matrix in the format of a tab-delimited text file (tsv). </span>
                    <span style="color: blue; ">The matrix file should have the first column as Feature/Transcript ID and the first row as Cell ID.</span>
                    <a style="color: red; text-decoration: underline;" href="/static/goolam_matrix.tsv">Click to see an example</a>
                </li>
                <li>
                    <span>an OPTIONAL metadata file in the format of a tab-delimited text file (tsv) that contains two columns: cell_id and cell_type.</span>
                    <span style="color: blue; ">The column names, which are "cell_id" and "cell_type", must be correct.</span>
                    <a style="color: red; text-decoration: underline;" href="/static/goolam_metadata.tsv">Click to see an example</a>
                </li>
            </ul>
        </div>

        <div id="content">
            <div id="col1" style="width: 28%; margin-left: 10px;">
                <div id="col1-section1" >
                    <div style="display: flex;">
                        <div style="display: flex; justify-content: center; align-items: center; flex-direction: column; width: 45%;">
                            <input type="file" id="matrixInput" name="matrixInput" style="display: none;">
                            <button style="font-size: 12px;" id="matrixInputBtn" onclick="uploadFile('matrixInput', 'matrixUploadProgress','deleteMatrixInputBtn','matrixName')">Upload matrix</button>
                            <progress id="matrixUploadProgress" max="100" value="0" style="display: none;"></progress>
                            <span id="matrixName"></span>
                            <button style="font-size: 12px; display: none;" id="deleteMatrixInputBtn">Delete</button>
                        </div>

                        <div style="width: 10%;"></div>

                        <div style="display: flex; justify-content: center; align-items: center; flex-direction: column; width: 45%;">
                            <input type="file" id="metadataInput" name="metadataInput" style="display: none;">
                            <button style="font-size: 12px;" id="metadataInputBtn" onclick="uploadFile('metadataInput', 'metadataUploadProgress','deleteMetadataInputBtn', 'metadataName')">Upload metadata</button>
                            <progress id="metadataUploadProgress" max="100" value="0" style="display: none;"></progress>
                            <span id="metadataName"></span>
                            <button style="font-size: 12px; display: None;" id="deleteMetadataInputBtn">Delete</button>
                        </div>
                    </div>

                    <h2 style="text-align: center;">OR</h2>

                    <h3 style="text-align: center;">Select a built-in dataset<div>(if not uploading a matrix)</div></h3> 

                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                          <label class="input-group-text" for="inputGroupSelect01">Options</label>
                        </div>
                        <select class="custom-select" id="inputGroupSelect01">
                          <option selected>None</option>
                          <option value="goolam">goolam</option>
                          <option value="segerstolpe">segerstolpe</option>
                        </select>
                    </div>
                      
                    <div style="text-align: center;">
                        <button id="startBtn" onclick="startTraining()">
                            <i id="spin" class="fa fa-spinner fa-spin" style="display: None;"></i>
                            <span>START TRAINING</span></button>
                    </div>

                    <div id="warning">

                    </div>
                </div>

                <div id="col1-section2" style="display: None;">
                    <div style="text-align: center; margin-top: 30px;">
                        <button id="downloadMatrixBtn" onclick="download('downloadLatentLink')">
                            <span>Download file</span> <br>
                            <span>(compressed data)</span>
                            <a id="downloadLatentLink" hidden></a>
                        </button>
                    </div>

                    <div style="text-align: center; margin-top: 30px;">
                        <button id="downloadMetadataBtn" onclick="download('downloadResultLink');">
                            <span>Download file</span></br> 
                            <span>(inference result)</span>
                            <a id="downloadResultLink" hidden></a>
                        </button>
                    </div>

                </div> 
            </div>

            <div style="width: 2%;"></div>

            <div id="col2" style="width: 65%;">
                <div>
                    <img id="resultImg" width="1100" height="700">
                </div>

                <div style="text-align: center; margin: 10px;">
                    <label for="widthInput">Width:</label>
                    <input type="number" id="widthInput" value="1100">
                    <label for="heightInput">Height:</label>
                    <input type="number" id="heightInput" value="700">
                    <button id="exportImgBtn">Export Image</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let imageWidth = 1100; // Default width
        let imageHeight = 700; // Default height

        function displayDownloadButton(){
            function inner(result_filename, latent_filename){
                var downloadArea = document.getElementById("col1-section2");
                var downloadResultLink = document.getElementById("downloadResultLink");
                downloadResultLink.setAttribute("href", "/download/" + result_filename)
                downloadResultLink.addEventListener("click", function(event) {
                    // Prevent the default navigation behavior
                    event.preventDefault();

                    // Open the link in a new tab/window
                    const newWindow = window.open(downloadResultLink.href, "_blank");

                });
                
                var downloadLatentLink = document.getElementById("downloadLatentLink");
                downloadLatentLink.setAttribute("href", "/download/" + latent_filename)
                downloadLatentLink.addEventListener("click", function(event) {
                    // Prevent the default navigation behavior
                    event.preventDefault();

                    // Open the link in a new tab/window
                    const newWindow = window.open(downloadLatentLink.href, "_blank");

                });

                downloadArea.style.display = "block";
            }

            return inner;
        }

        function displayResultImg(filename){
            fetch("/showResultImg/" + filename, {
                method: "GET",
            })  // Replace with the actual path to your image
                .then(response => response.blob())
                .then(blob => {
                    // Create a DOMString representing the image data
                    const imageUrl = URL.createObjectURL(blob);

                    // Get an <img> element with the image URL
                    const img = document.getElementById("resultImg");
                    img.src = imageUrl;

                })
                .catch(error => {
                    console.error("Error:", error);
                });
        }

        function generateUUID() { // Public Domain/MIT
            var d = new Date().getTime();//Timestamp
            var d2 = ((typeof performance !== 'undefined') && performance.now && (performance.now()*1000)) || 0;//Time in microseconds since page-load or 0 if unsupported
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16;//random number between 0 and 16
                if(d > 0){//Use timestamp until depleted
                    r = (d + r)%16 | 0;
                    d = Math.floor(d/16);
                } else {//Use microseconds since page-load if supported
                    r = (d2 + r)%16 | 0;
                    d2 = Math.floor(d2/16);
                }
                return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
            });
        }

        function download(a_id){
            var a = document.getElementById(a_id);
            a.addEventListener("click", function(event) {
                // Prevent the default navigation behavior
                event.preventDefault();

                // Open the link in a new tab/window
                const newWindow = window.open(a.href, "_blank");

            });
            a.click();
        }

        // Set a cookie with a name, value, and optional expiration date
        function setCookie(name, value, expires) {
            document.cookie = name + "=" + value + "; expires=" + expires + "; path=/";
        }

        function startTraining() {
            var fileMatrixInput = document.getElementById("matrixInput");
            var fileMatrix = fileMatrixInput.files[0];
            var deleteMatrixBtn = document.getElementById("deleteMatrixInputBtn");
            var fileMetadataInput = document.getElementById("metadataInput");
            var fileMetadata = fileMetadataInput.files[0];
            var deleteMetadataBtn = document.getElementById("deleteMetadataInputBtn");
            var selectedDataset = document.getElementById("inputGroupSelect01").value;
            var downloadArea = document.getElementById("col1-section2");
            downloadArea.style.display = "None";
            // Get an <img> element with the image URL
            const img = document.getElementById("resultImg");
            img.src = "";

            if (typeof fileMatrix === 'undefined' && selectedDataset === 'None'){
                alert("You must upload a scDHA matrix or choose a built-in dataset");
                return ;
            }

            if (typeof fileMatrix === 'undefined'){
                var xhr = new XMLHttpRequest();

                // Set the request method and URL
                xhr.open("POST", "/upload3", true);

                // Set the Content-Type header
                xhr.setRequestHeader("Content-Type", "application/json");

                // Handle the response
                xhr.onload = function () {
                    if (xhr.status === 200) {
                        const response = JSON.parse(xhr.responseText);
                        // Handle the response data
                        displayDownloadButton()(response['result_filename'], response['latent_filename']);
                        displayResultImg(response['image_url']);
                        fileMatrixInput.value = "";
                        fileMetadataInput.value = "";
                        var matrixProgress = document.getElementById("matrixUploadProgress");
                        matrixProgress.style.display = 'None';
                        var metadataProgress = document.getElementById("metadataUploadProgress");
                        metadataProgress.style.display = 'None';
                        deleteMatrixBtn.style.display = 'None';
                        deleteMetadataBtn.style.display = 'None';
                        
                    } else {
                        console.error("Request failed. Status: " + xhr.status);
                        // Handle errors
                    }
                };

                // Create a JSON payload with the filename
                const dataset_name = selectedDataset;
                const payload = { dataset_name };

                // Convert the payload to a JSON string
                const payloadString = JSON.stringify(payload);

                // Send the POST request with the payload
                console.log(payloadString);
                xhr.send(payloadString);
            }
            else{
                if (selectedDataset !== 'None'){
                    var choice = confirm("You are uploading a matrix and selecting a built-in dataset. We will use your matrix. Do you want to continue?");

                    if (!choice){
                        return ;
                    }
                }

                var startBtn = document.getElementById("startBtn");
                var span = startBtn.querySelectorAll("span")[0];
                var spin = document.getElementById("spin");
                spin.style.display = "block";
                span.innerText = " PROCESSING";
                startBtn.disabled = true;

                var formData = new FormData();
                formData.append("fileMatrix", fileMatrix);

                if (fileMetadata){
                    formData.append("fileMetadata", fileMetadata);
                }

                var xhr = new XMLHttpRequest();

                if (fileMetadata){
                    xhr.open("POST", "/upload2", true);
                }
                else{
                    xhr.open("POST", "/upload1", true);
                }

                // Track upload progress
                // xhr.upload.onprogress = function(event) {
                //     var progressBar = document.getElementById("progressBarFill");
                //     var progressPercentage = Math.round((event.loaded / event.total) * 100);
                //     progressBar.style.width = progressPercentage + "%";
                // };

                // Handle response from the server
                xhr.onload = function() {
                    if (xhr.status === 200) {
                        const response = JSON.parse(xhr.responseText);
                        // File uploaded successfully
                        if (response["error"]){
                            alert(response["error"]);
                        }
                        else{
                            displayDownloadButton()(response['result_filename'], response['latent_filename']);
                            displayResultImg(response['image_url']);
                            alert("Train successfully");
                        }
                        span.innerText = "START TRAINING";
                        spin.style.display = "None";
                        startBtn.disabled = false;
                    } else {
                        // Error during file upload
                        span.innerText = "START TRAINING";
                        spin.style.display = "None";
                        startBtn.disabled = false;
                        alert("Error uploading file");
                    }
                };
                // Send the file data
                xhr.send(formData);
            }
        }

        function processFile(){
            var fileInput = document.getElementById("fileInput");
            var file = fileInput.files[0];

            if (file){
                // Create a new XMLHttpRequest object
                const xhr = new XMLHttpRequest();

                // Set the request method and URL
                xhr.open("POST", "/processFile", true);

                // Set the Content-Type header
                xhr.setRequestHeader("Content-Type", "application/json");

                // Handle the response
                xhr.onload = function () {
                    if (xhr.status === 200) {
                        const response = JSON.parse(xhr.responseText);
                        // Handle the response data
                        alert("Train successfully");
                        displayDownloadButton()(response['result_filename'], response['latent_filename']);
                        displayResultImg(response['image_url']);

                    } else {
                        alert("Request failed.");
                        // Handle errors
                    }
                };

                // Create a JSON payload with the filename
                const filename = file.name;
                const payload = { filename };

                // Convert the payload to a JSON string
                const payloadString = JSON.stringify(payload);

                // Send the POST request with the payload
                console.log(payloadString);
                xhr.send(payloadString);
            }
        }


        // Generate cookie
        var cookieName = "scDHA_session_id";
        if (!document.cookie.includes(cookieName)){
            var cookieValue = generateUUID();
            var expirationDate = new Date(Date.now() + 86400000); // Expires in 24 hours
            setCookie(cookieName, cookieValue, expirationDate.toUTCString());
        }

        exportImgBtn.addEventListener("click", () => {
            const canvas = document.createElement("canvas");
            canvas.width = imageWidth;
            canvas.height = imageHeight;

            const ctx = canvas.getContext("2d");
            const img = document.getElementById("resultImg");
            ctx.drawImage(img, 0, 0, imageWidth, imageHeight);

            const dataUrl = canvas.toDataURL("image/png");
            const link = document.createElement("a");
            link.href = dataUrl;
            link.download = "exported_image.png";
            link.click();
        });

        widthInput.addEventListener("input", () => {
            imageWidth = parseInt(widthInput.value);
        });

        heightInput.addEventListener("input", () => {
            imageHeight = parseInt(heightInput.value);
        });

    </script>
</body>
</html>
